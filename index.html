<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è‹±èªãƒ†ã‚­ã‚¹ãƒˆèª­ã¿ä¸Šã’</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f5f7fb; padding: 24px; }
    .container { max-width: 900px; margin: 0 auto; background:#fff; border-radius: 16px; box-shadow: 0 12px 30px rgba(0,0,0,.08); padding: 28px; }
    h1 { font-size: 1.6rem; margin-bottom: 10px; color:#333; }
    .hint { color:#666; font-size:.9rem; margin-bottom: 16px; }
    label { font-weight: 600; color:#444; display:block; margin-top: 8px; margin-bottom: 6px; }
    textarea {
      width: 100%; min-height: 200px; padding: 12px 14px; border: 2px solid #e6e8ee; border-radius: 12px;
      font: 16px/1.6 "Georgia", serif; resize: vertical; background:#fafbff;
    }
    textarea:focus { outline: none; border-color: #8aa4ff; background:#fff; box-shadow: 0 0 0 3px rgba(138,164,255,.15); }
    .row { display:flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-top: 10px; }
    select, button {
      border-radius: 10px; border: 2px solid #e6e8ee; padding: 8px 12px; background:#fff; font-weight:600;
    }
    select:focus { outline:none; border-color:#8aa4ff; }
    button { cursor: pointer; transition:.2s; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .play { background:#2ecc71; border-color:#2ecc71; color:#fff; }
    .pause { background:#ffb74d; border-color:#ffb74d; color:#fff; }
    .stop { background:#e74c3c; border-color:#e74c3c; color:#fff; }
    .clear { background:#9e9e9e; border-color:#9e9e9e; color:#fff; }
    .reset { background:#556cd6; border-color:#556cd6; color:#fff; }
    .meta { display:flex; justify-content: space-between; align-items: baseline; flex-wrap: wrap; gap: 8px; }
    .char-counter { color:#666; font-size:.85rem; }
    .estimate { color:#444; font-size:.9rem; font-weight:600; }
    .viewer {
      margin-top: 16px; border: 2px solid #e6e8ee; border-radius: 12px; padding: 14px; background:#fff;
      max-height: 360px; overflow: auto; white-space: pre-wrap;
    }
    .sentence { padding: 2px 3px; border-radius: 4px; }
    .sentence.highlight { background: #ffeb3b; }
    .statusbar { display:flex; justify-content: space-between; align-items:center; margin-top: 12px; }
    .status { padding: 6px 10px; border-radius: 8px; font-weight:600; color:#2e7d2e; background:#eaf6ea; border:1px solid #b8e0b8; }
    .status.speaking { color:#8a4b00; background:#fff3e0; border-color:#ffd9a8; }
    .status.paused { color:#0b60b0; background:#e9f3ff; border-color:#cfe4ff; }
    .timer { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 1.3rem; }
    .footnote { margin-top: 12px; color:#666; font-size:.85rem; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§ è‹±èªãƒ†ã‚­ã‚¹ãƒˆèª­ã¿ä¸Šã’</h1>
    <p class="hint">æœ€å¤§ <b>10,000æ–‡å­—</b>ã€‚æ–‡ç« å˜ä½ã§èª­ã¿ä¸Šã’ãƒ»ãƒã‚¤ãƒ©ã‚¤ãƒˆã€‚åœæ­¢ãƒ»ãƒ†ã‚­ã‚¹ãƒˆã‚¯ãƒªã‚¢ãƒ»å…¨ãƒªã‚»ãƒƒãƒˆå¯¾å¿œã€‚<br>ç›®å®‰ã®æ‰€è¦æ™‚é–“ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§è¡¨ç¤ºã—ã¾ã™ï¼ˆæ¨å®šï¼‰ã€‚</p>

    <label for="text">ãƒ†ã‚­ã‚¹ãƒˆ</label>
    <textarea id="text" maxlength="10000" placeholder="Enter English text here (up to 10,000 chars)..."></textarea>
    <div class="meta">
      <div class="char-counter" id="counter">0 / 10000</div>
      <div class="estimate" id="estimate">æ‰€è¦æ™‚é–“ã®ç›®å®‰: 00:00</div>
    </div>

    <div class="row">
      <label for="rate">å†ç”Ÿé€Ÿåº¦</label>
      <select id="rate" aria-label="Playback rate">
        <option value="0.75">0.75x</option>
        <option value="1" selected>1.0x</option>
        <option value="1.25">1.25x</option>
        <option value="1.5">1.5x</option>
      </select>

      <button id="play" class="play">â–¶ å†ç”Ÿ</button>
      <button id="pause" class="pause" disabled>â¸ ä¸€æ™‚åœæ­¢</button>
      <button id="stop" class="stop" disabled>â¹ åœæ­¢</button>
      <button id="clearText" class="clear">ğŸ§½ ã‚¯ãƒªã‚¢ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰</button>
      <button id="resetAll" class="reset">ğŸ” ãƒªã‚»ãƒƒãƒˆï¼ˆå…¨éƒ¨ï¼‰</button>
    </div>

    <div class="viewer" id="viewer" aria-live="polite"></div>

    <div class="statusbar">
      <div class="status" id="status">æº–å‚™å®Œäº†</div>
      <div class="timer" id="timer">00:00</div>
    </div>

    <div class="footnote">â€» æ¨å®šæ™‚é–“ã¯ã€Œå˜èªæ•° Ã· (åŸºæº–WPMÃ—å†ç”Ÿé€Ÿåº¦)ã€ã§è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚åŸºæº–WPMã¯ <b>140</b> ã¨ã—ã¦ãŠã‚Šã€å®Ÿéš›ã®TTSãƒ»æ–‡æ§‹é€ ã«ã‚ˆã‚Šå‰å¾Œã—ã¾ã™ã€‚<br>â€» ãƒ–ãƒ©ã‚¦ã‚¶ã®éŸ³å£°åˆæˆAPIã‚’ä½¿ç”¨ã—ã¾ã™ï¼ˆChrome æ¨å¥¨ï¼‰ã€‚</div>
  </div>

  <script>
    const MAX_LEN = 10000;
    const BASE_WPM = 140; // æ¨å®šãƒ™ãƒ¼ã‚¹

    const synthesis = window.speechSynthesis;

    const elText = document.getElementById('text');
    const elCounter = document.getElementById('counter');
    const elRate = document.getElementById('rate');
    const elPlay = document.getElementById('play');
    const elPause = document.getElementById('pause');
    const elStop = document.getElementById('stop');
    const elClearText = document.getElementById('clearText');
    const elResetAll = document.getElementById('resetAll');
    const elViewer = document.getElementById('viewer');
    const elStatus = document.getElementById('status');
    const elTimer = document.getElementById('timer');
    const elEstimate = document.getElementById('estimate');

    let sentences = [];
    let idx = 0;
    let isPaused = false;
    let currentUtterance = null;

    // timer
    let startTime = 0;
    let elapsed = 0;
    let timerHandle = null;

    function startTimer() {
      startTime = Date.now();
      timerHandle = setInterval(() => {
        const t = elapsed + (Date.now() - startTime);
        const m = Math.floor(t / 60000);
        const s = Math.floor((t % 60000) / 1000);
        elTimer.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      }, 100);
    }
    function stopTimer() { if (timerHandle) { clearInterval(timerHandle); timerHandle = null; } }
    function resetTimer() { stopTimer(); elapsed = 0; elTimer.textContent = '00:00'; }

    function setStatus(state) {
      elStatus.className = 'status';
      if (state === 'speaking') { elStatus.classList.add('speaking'); elStatus.textContent = 'èª­ã¿ä¸Šã’ä¸­...'; }
      else if (state === 'paused') { elStatus.classList.add('paused'); elStatus.textContent = 'ä¸€æ™‚åœæ­¢ä¸­'; }
      else { elStatus.textContent = 'æº–å‚™å®Œäº†'; }
    }

    function escapeHTML(str) {
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }

    // æ–‡ç« ã«åˆ†å‰²ï¼ˆè‹±èªã‚’æƒ³å®šã€‚çµ‚ç«¯è¨˜å· . ! ? ã¨æ”¹è¡Œã§åŒºåˆ‡ã‚Šï¼‰
    function splitIntoSentences(text) {
      const raw = text.match(/[^.!?\n]+(?:[.!?]+|(?:\n+)|$)/g) || [];
      return raw.map(s => s.replace(/\s+$/,'')).map(s => s.trim()).filter(Boolean);
    }

    function renderSentences(list) {
      const html = list.map((s, i) => `<span id="sent-${i}" class="sentence">${escapeHTML(s)}</span> `).join('');
      elViewer.innerHTML = html;
    }

    function clearHighlight() {
      const prev = elViewer.querySelector('.sentence.highlight');
      if (prev) prev.classList.remove('highlight');
    }

    function highlightCurrent() {
      clearHighlight();
      const span = document.getElementById(`sent-${idx}`);
      if (span) {
        span.classList.add('highlight');
        span.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }

    // å†ç”Ÿï¼ˆæ–‡ã”ã¨ã« utterance ã‚’ç”Ÿæˆï¼‰
    function speakCurrentSentence() {
      if (idx >= sentences.length) {
        // å®Œäº†
        stopTimer();
        elapsed += (Date.now() - startTime);
        setStatus('ready');
        elPlay.disabled = false;
        elPause.disabled = true;
        elStop.disabled = true;
        currentUtterance = null;
        return;
      }

      const text = sentences[idx];
      highlightCurrent();

      currentUtterance = new SpeechSynthesisUtterance(text);
      currentUtterance.lang = 'en-US';
      currentUtterance.rate = parseFloat(elRate.value);
      currentUtterance.pitch = 1;

      currentUtterance.onstart = () => { setStatus('speaking'); };
      currentUtterance.onend = () => {
        if (!isPaused) {
          idx += 1;
          speakCurrentSentence();
        }
      };
      currentUtterance.onerror = (e) => {
        console.error('speech error', e);
        if (!isPaused) {
          idx += 1;
          speakCurrentSentence();
        }
      };

      synthesis.speak(currentUtterance);
    }

    function stopSpeakingKeepText() {
      synthesis.cancel();
      stopTimer();
      elapsed += (Date.now() - startTime);
      setStatus('ready');
      isPaused = false;
      currentUtterance = null;
      clearHighlight();
      elPlay.disabled = false;
      elPause.disabled = true;
      elStop.disabled = true;
    }

    function resetAll() {
      synthesis.cancel();
      stopTimer();
      resetTimer();
      setStatus('ready');
      isPaused = false;
      currentUtterance = null;
      sentences = [];
      idx = 0;
      elViewer.innerHTML = "";
      elPlay.disabled = false;
      elPause.disabled = true;
      elStop.disabled = true;
    }

    // --- Estimator ---
    function mmss(minutesFloat) {
      const totalSeconds = Math.max(0, Math.round(minutesFloat * 60));
      const m = Math.floor(totalSeconds / 60);
      const s = totalSeconds % 60;
      return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function updateEstimate() {
      const text = elText.value;
      const words = (text.trim().match(/\b[\w'-]+\b/g) || []).length;
      const rate = parseFloat(elRate.value || "1");
      const wpm = BASE_WPM * rate;
      const minutes = words / Math.max(1, wpm);
      elEstimate.textContent = `æ‰€è¦æ™‚é–“ã®ç›®å®‰: ${mmss(minutes)}ï¼ˆç´„ ${words} words, é€Ÿåº¦ ${rate}xï¼‰`;
    }

    // --- UI handlers ---
    elPlay.addEventListener('click', () => {
      const raw = elText.value.trim();
      if (!raw) { alert('ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      if (!('speechSynthesis' in window)) { alert('éŸ³å£°åˆæˆæ©Ÿèƒ½ãŒä½¿ãˆã¾ã›ã‚“ã€‚å¯¾å¿œãƒ–ãƒ©ã‚¦ã‚¶ã§ãŠè©¦ã—ãã ã•ã„ã€‚'); return; }

      // ä¸€æ™‚åœæ­¢ã‹ã‚‰ã®å†é–‹
      if (isPaused && synthesis.speaking) {
        isPaused = false;
        synthesis.resume();
        startTimer();
        setStatus('speaking');
        elPlay.disabled = true;
        elPause.disabled = false;
        elStop.disabled = false;
        return;
      }

      // æ–°è¦é–‹å§‹ï¼ˆå¸¸ã«å…ˆé ­ã‹ã‚‰ï¼‰
      synthesis.cancel(); // å¿µã®ãŸã‚æ—¢å­˜ã‚­ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
      idx = 0;
      isPaused = false;
      sentences = splitIntoSentences(raw);
      if (sentences.length === 0) { alert('èª­ã¿ä¸Šã’ã‚‹æ–‡ç« ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'); return; }
      renderSentences(sentences);
      highlightCurrent();

      resetTimer();
      startTimer();
      setStatus('speaking');
      elPlay.disabled = true;
      elPause.disabled = false;
      elStop.disabled = false;

      speakCurrentSentence();
    });

    elPause.addEventListener('click', () => {
      if (synthesis.speaking && !isPaused) {
        synthesis.pause();
        isPaused = true;
        stopTimer();
        elapsed += (Date.now() - startTime);
        setStatus('paused');
        elPlay.disabled = false; // å†é–‹ãƒœã‚¿ãƒ³ã¨ã—ã¦æ©Ÿèƒ½
        elPause.disabled = true;
        elStop.disabled = false;
      }
    });

    elStop.addEventListener('click', () => {
      stopSpeakingKeepText();
    });

    elClearText.addEventListener('click', () => {
      synthesis.cancel();
      isPaused = false;
      currentUtterance = null;
      elText.value = "";
      elCounter.textContent = `0 / ${MAX_LEN}`;
      sentences = [];
      idx = 0;
      elViewer.innerHTML = "";
      stopTimer();
      resetTimer();
      setStatus('ready');
      elPlay.disabled = false;
      elPause.disabled = true;
      elStop.disabled = true;
      updateEstimate();
    });

    elResetAll.addEventListener('click', () => {
      resetAll();
      elText.value = "";
      elCounter.textContent = `0 / ${MAX_LEN}`;
      updateEstimate();
    });

    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
    elText.addEventListener('input', () => {
      let val = elText.value;
      if (val.length > MAX_LEN) {
        elText.value = val.slice(0, MAX_LEN);
      }
      const len = elText.value.length;
      elCounter.textContent = `${len} / ${MAX_LEN}`;
      updateEstimate();
    });

    // é€Ÿåº¦å¤‰æ›´æ™‚ã¯æ¨å®šæ™‚é–“ã ã‘å³åæ˜ ï¼ˆå®Ÿéš›ã®TTSé€Ÿåº¦ã‚‚æ¬¡ã®æ–‡ã‹ã‚‰åæ˜ ï¼‰
    elRate.addEventListener('change', () => {
      updateEstimate();
    });

    // åˆæœŸçŠ¶æ…‹
    setStatus('ready');
    elCounter.textContent = `0 / ${MAX_LEN}`;
    elPause.disabled = true;
    elStop.disabled = true;
    updateEstimate();
  </script>
</body>
</html>
